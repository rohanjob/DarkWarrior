# Azure DevOps Pipeline for Darksite
# Continuous Integration and Continuous Deployment
# Study Purpose Only

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'frontend/**'
      - 'backend/**'

# Use Windows agent (can also use ubuntu-latest)
pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  dotnetSdkVersion: '8.x'
  
  # Backend variables
  backendProject: 'backend/Darksite.API/Darksite.API.csproj'
  backendArtifact: 'backend-drop'
  
  # Frontend variables
  frontendProject: 'frontend/Darksite.Web/Darksite.Web.csproj'
  frontendArtifact: 'frontend-drop'
  
  # Azure variables (set these in Azure DevOps Pipeline Variables as secrets)
  # azureSubscription: 'your-service-connection'
  # backendWebAppName: 'darksite-api'
  # frontendWebAppName: 'darksite-web'

stages:
  # =====================================================
  # STAGE 1: BUILD
  # =====================================================
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildBackend
        displayName: 'Build Backend API'
        steps:
          # Install .NET SDK
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: $(dotnetSdkVersion)
              packageType: 'sdk'
          
          # Restore NuGet packages
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: '$(backendProject)'
          
          # Build the project
          - task: DotNetCoreCLI@2
            displayName: 'Build Backend'
            inputs:
              command: 'build'
              projects: '$(backendProject)'
              arguments: '--configuration $(buildConfiguration) --no-restore'
          
          # Run tests (if you have test projects)
          # - task: DotNetCoreCLI@2
          #   displayName: 'Run Tests'
          #   inputs:
          #     command: 'test'
          #     projects: '**/Darksite.Tests/*.csproj'
          #     arguments: '--configuration $(buildConfiguration) --no-build'
          
          # Publish the project
          - task: DotNetCoreCLI@2
            displayName: 'Publish Backend'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(backendProject)'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/backend --no-build'
              zipAfterPublish: true
          
          # Publish artifact for deployment
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Backend Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend'
              ArtifactName: '$(backendArtifact)'
              publishLocation: 'Container'

      - job: BuildFrontend
        displayName: 'Build Frontend Web'
        steps:
          # Install .NET SDK
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: $(dotnetSdkVersion)
              packageType: 'sdk'
          
          # Restore NuGet packages
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: '$(frontendProject)'
          
          # Build the project
          - task: DotNetCoreCLI@2
            displayName: 'Build Frontend'
            inputs:
              command: 'build'
              projects: '$(frontendProject)'
              arguments: '--configuration $(buildConfiguration) --no-restore'
          
          # Publish the project
          - task: DotNetCoreCLI@2
            displayName: 'Publish Frontend'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: '$(frontendProject)'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/frontend --no-build'
              zipAfterPublish: true
          
          # Publish artifact for deployment
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Frontend Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend'
              ArtifactName: '$(frontendArtifact)'
              publishLocation: 'Container'

  # =====================================================
  # STAGE 2: DEPLOY TO DEVELOPMENT
  # =====================================================
  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployBackendDev
        displayName: 'Deploy Backend to Dev'
        environment: 'Development'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy Backend API to Azure'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webApp'
                    appName: '$(backendWebAppName)-dev'
                    package: '$(Pipeline.Workspace)/$(backendArtifact)/**/*.zip'
                    deploymentMethod: 'auto'

      - deployment: DeployFrontendDev
        displayName: 'Deploy Frontend to Dev'
        environment: 'Development'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy Frontend Web to Azure'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webApp'
                    appName: '$(frontendWebAppName)-dev'
                    package: '$(Pipeline.Workspace)/$(frontendArtifact)/**/*.zip'
                    deploymentMethod: 'auto'

  # =====================================================
  # STAGE 3: DEPLOY TO PRODUCTION
  # =====================================================
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployBackendProd
        displayName: 'Deploy Backend to Production'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy Backend API to Azure'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webApp'
                    appName: '$(backendWebAppName)'
                    package: '$(Pipeline.Workspace)/$(backendArtifact)/**/*.zip'
                    deploymentMethod: 'auto'
                    
                # Optional: Run database migrations
                # - task: SqlAzureDacpacDeployment@1
                #   displayName: 'Run Database Migrations'
                #   inputs:
                #     azureSubscription: '$(azureSubscription)'
                #     ServerName: '$(sqlServerName).database.windows.net'
                #     DatabaseName: 'DarksiteDb'
                #     SqlUsername: '$(sqlUsername)'
                #     SqlPassword: '$(sqlPassword)'
                #     deployType: 'InlineSqlTask'
                #     SqlInline: |
                #       -- Your migration scripts here

      - deployment: DeployFrontendProd
        displayName: 'Deploy Frontend to Production'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy Frontend Web to Azure'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webApp'
                    appName: '$(frontendWebAppName)'
                    package: '$(Pipeline.Workspace)/$(frontendArtifact)/**/*.zip'
                    deploymentMethod: 'auto'

# =====================================================
# ADDITIONAL CONFIGURATION NOTES
# =====================================================
# 
# To use this pipeline:
# 1. Create an Azure DevOps project
# 2. Create service connections for Azure subscription
# 3. Set up pipeline variables (can be done in Azure DevOps UI):
#    - azureSubscription: Your Azure service connection name
#    - backendWebAppName: Name of backend App Service (e.g., darksite-api)
#    - frontendWebAppName: Name of frontend App Service (e.g., darksite-web)
#    - sqlServerName: Azure SQL server name (optional)
#    - sqlUsername: SQL admin username (optional, mark as secret)
#    - sqlPassword: SQL admin password (optional, mark as secret)
#
# 4. Create environments in Azure DevOps:
#    - Development (for develop branch)
#    - Production (for main branch, add approval gates)
#
# 5. Push code to trigger the pipeline!
#
# For local testing:
#   dotnet build
#   dotnet publish -c Release
#
